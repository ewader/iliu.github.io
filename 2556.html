<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>lnmp一键开启waf及使用 Fail2Ban防护 | 老刘博客</title><meta name=keywords content="cnd获取真实ip,Fail2Ban,lnmp"><meta name=description content="试用了阿里云香港的轻量服务器之后，赶紧确实是一个不错的选择，因此，决定把网站给迁移过来。以前都是用的oneinstack安装包，这是因为军哥的lnmp如果使用mysql5.6以上的话就必须要内存2G衣裳，这次用的就是2G的，所以还是使用lnmp一键安装包比较舒心。和one的区别是，one很多的事项在编译环境的时候已经弄好了，而lnmp需要西西的打磨，这也是一个好事，毕竟服务器不同，弄的规则也不尽一样。闲言少续，开始正体。"><meta name=author content="老刘"><link rel=canonical href=https://iliu.org/2556.html><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://iliu.org/img/favicon><link rel=icon type=image/png sizes=16x16 href=https://iliu.org/img/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://iliu.org/img/favicon-32x32.png><link rel=apple-touch-icon href=https://iliu.org/img/apple-touch-icon.png><link rel=mask-icon href=https://iliu.org/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://iliu.org/2556.html><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://iliu.org/2556.html"><meta property="og:site_name" content="老刘博客"><meta property="og:title" content="lnmp一键开启waf及使用 Fail2Ban防护"><meta property="og:description" content="试用了阿里云香港的轻量服务器之后，赶紧确实是一个不错的选择，因此，决定把网站给迁移过来。以前都是用的oneinstack安装包，这是因为军哥的lnmp如果使用mysql5.6以上的话就必须要内存2G衣裳，这次用的就是2G的，所以还是使用lnmp一键安装包比较舒心。和one的区别是，one很多的事项在编译环境的时候已经弄好了，而lnmp需要西西的打磨，这也是一个好事，毕竟服务器不同，弄的规则也不尽一样。闲言少续，开始正体。"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-07-28T09:07:40+00:00"><meta property="article:modified_time" content="2019-07-28T09:07:40+00:00"><meta property="article:tag" content="Cnd获取真实ip"><meta property="article:tag" content="Fail2Ban"><meta property="article:tag" content="Lnmp"><meta property="og:image" content="https://iliu.org/img/liujinsuiyue.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://iliu.org/img/liujinsuiyue.jpg"><meta name=twitter:title content="lnmp一键开启waf及使用 Fail2Ban防护"><meta name=twitter:description content="试用了阿里云香港的轻量服务器之后，赶紧确实是一个不错的选择，因此，决定把网站给迁移过来。以前都是用的oneinstack安装包，这是因为军哥的lnmp如果使用mysql5.6以上的话就必须要内存2G衣裳，这次用的就是2G的，所以还是使用lnmp一键安装包比较舒心。和one的区别是，one很多的事项在编译环境的时候已经弄好了，而lnmp需要西西的打磨，这也是一个好事，毕竟服务器不同，弄的规则也不尽一样。闲言少续，开始正体。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://iliu.org/posts/"},{"@type":"ListItem","position":2,"name":"lnmp一键开启waf及使用 Fail2Ban防护","item":"https://iliu.org/2556.html"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"lnmp一键开启waf及使用 Fail2Ban防护","name":"lnmp一键开启waf及使用 Fail2Ban防护","description":"试用了阿里云香港的轻量服务器之后，赶紧确实是一个不错的选择，因此，决定把网站给迁移过来。以前都是用的oneinstack安装包，这是因为军哥的lnmp如果使用mysql5.6以上的话就必须要内存2G衣裳，这次用的就是2G的，所以还是使用lnmp一键安装包比较舒心。和one的区别是，one很多的事项在编译环境的时候已经弄好了，而lnmp需要西西的打磨，这也是一个好事，毕竟服务器不同，弄的规则也不尽一样。闲言少续，开始正体。\n","keywords":["cnd获取真实ip","Fail2Ban","lnmp"],"articleBody":"试用了阿里云香港的轻量服务器之后，赶紧确实是一个不错的选择，因此，决定把网站给迁移过来。以前都是用的oneinstack安装包，这是因为军哥的lnmp如果使用mysql5.6以上的话就必须要内存2G衣裳，这次用的就是2G的，所以还是使用lnmp一键安装包比较舒心。和one的区别是，one很多的事项在编译环境的时候已经弄好了，而lnmp需要西西的打磨，这也是一个好事，毕竟服务器不同，弄的规则也不尽一样。闲言少续，开始正体。\nlnmp开启waf的方法 LNMP一键安装包从1.5开始增加了lua支持的选项，可以通过修改lnmp.conf中Enable_Nginx_Lua后的参数为 y 来启用lua，如果没安装lnmp，修改lnmp.conf后保存，安装完lnmp就是支持lua的，如果已经安装好lnmp，也是按前面修改lnmp.conf，然后lnmp安装包目录下 ./upgrade.sh nginx 升级nginx，输入当前 nginx 版本号或更新的nginx版本号，升级完成就是支持lua的了。\n下载安装ngx_lua_waf： wget https://github.com/loveshell/ngx_lua_waf/archive/master.zip -O ngx_lua_waf.zip\nunzip ngx_lua_waf.zip\nmv ngx_lua_waf-master /usr/local/nginx/conf/waf\nnginx上设置并启用ngx_lua_waf 编辑 /usr/local/nginx/conf/nginx.conf 在 server_tokens off; 下面添加如下代码：\nlua_package_path “/usr/local/nginx/conf/waf/?.lua”;\nlua_shared_dict limit 10m;\ninit_by_lua_file /usr/local/nginx/conf/waf/init.lua;\n修改完成保存\n如果要想在某个虚拟主机启用ngx_lua_waf可以修改对应虚拟主机的server段，在该server段中 root 网站目录行下面添加如下代码：\naccess_by_lua_file /usr/local/nginx/conf/waf/waf.lua;\n修改完成保存\n测试nginx配置文件： /usr/local/nginx/sbin/nginx -t\n重载nginx配置生效： /usr/local/nginx/sbin/nginx -s reload\n如果测试和重载都没报错就已经生效。\n可以通过访问 http://域名/test.php?id=../etc/passwd 来测试\n提示：您的请求带有\u003e不合法参数，已被网站管理员设置拦截！说明已经正确设置\nngx_lua_waf配置文件位置：/usr/local/nginx/conf/waf/config.lua\n使用 Fail2Ban防护网站及服务器 Fail2Ban 是一种入侵防御软件框架，可以保护计算机服务器免受暴力攻击。它以 Python 编程语言编写，能够在 POSIX 系统上运行，该系统具有本地安装的数据包控制系统或防火墙的接口，例如 iptables 或 TCP Wrapper。\n所以要想使用Fail2Ban，就必须让服务器识别来源的真实IP地址，而不是套的cdn的地址。\n套用CDN后获取来源的真实IP的方法\n在nginx.conf内的http下增加：\n#自定义一个日志格式\nlog_format main '$http_x_forwarded_for - $remote_user [$time_local] '\n‘”$request” $status $body_bytes_sent ‘\n‘”$http_referer” “$http_user_agent”‘;\n然后修改access_log /home/wwwlogs/xxxx.log; 为access_log /home/wwwlogs/xxxx.log main;\nnginx-t 检查无误后，service nginx restart,现在在看日志文件，里面的地址就是真正的来源地址了。\n使用 Fail2Ban 保护 Nginx、WordPress\ncp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local Fail2Ban 会自动读取 .local 文件的配置，然后再增量地读取 conf 配置，这样就避免了更新它时你辛辛苦苦写好的配置被覆盖掉了。\n然后我们就来编辑 Fail2Ban 的配置\nvim /etc/fail2ban/jail.local 首先是在 [DEFAULT] 字段下，我们可以改变一些行为参数，比如这样修改（多余的没有提到的配置就保留默认，不要理会即可）：\nbantime = 3600 #默认是 10 分钟，这个是说要 ban 多久，我们改长一点 #下面这两个是说在多长时间内失败多少次就被屏蔽， #比如这个是在 3600 秒内失败 6 次就被屏蔽 findtime = 3600 maxretry = 6 接下来就是添加我们的监狱配置了，默认配置信息中并没有内置 Nginx ，只有 Apache：\n[nginx-http-auth] # HTTP 验证防暴力破解 enabled = true filter = nginx-http-auth port = http,https logpath = /var/log/nginx/error.log [nginx-badbots] #屏蔽恶意爬虫 enabled = true port = http,https filter = nginx-badbots logpath = /var/log/nginx/access.log maxretry = 2 [nginx-nohome] #避免恶意请求网站目录结构 enabled = true port = http,https filter = nginx-nohome logpath = /var/log/nginx/access.log maxretry = 2 [nginx-noproxy] #避免 nginx 被他人用于反向代理 enabled = true port = http,https filter = nginx-noproxy logpath = /var/log/nginx/access.log maxretry = 2 [wp-login] #防范 WordPress 暴力破解登录请求 enabled = true port = http,https filter = wp-login maxretry = 10 findtime = 60 bantime = 43600 logpath = /var/log/nginx/access.log [xmlrpc] #防止 WordPress 受到 xmlrpc.php CC 攻击 enabled = true port = http,https filter = xmlrpc logpath = /var/log/nginx/access.log bantime = 43600 maxretry = 1 findtime = 5 注意这里的配置都是基于 Nginx 的日志的，所以你必须要允许 Nginx 记录日志，有些管理员为了性能考量会关闭日志，这样我们这篇文章也就失去了意义。\n上述配置中 logpath 是指日志文件的路径的（如：/var/log/nginx/access.log），需要注意的是这里可以指定多个日志文件的，具体格式如下：\nlogpath = /home/wwwlogs/access.log /home/wwwlogs/www.1111.com.log /home/wwwlogs/www.2222.tech.log /home/wwwlogs/service.3333.com.log /home/wwwlogs/eat.4444.com.log 每个日志文件需要回车换行（空格直接去掉了，所以可以放心用空格对齐）才能识别到哦！\n另，在配置 Fail2Ban 之前，你就应该先安装好 Nginx，否则 Fail2Ban 读不到 Nginx 的日志，会报错。\n设置好了要启用的监狱，接下来就是给监狱创建规则了：\ncd /etc/fail2ban/filter.d 在这个目录下，存放这所有规则文件，一个配置名一个文件，有多少个文件就有多少个规则，这些规则被上文中监狱配置里 filter 字段调用。\nvim nginx-http-auth.conf 这个规则是存在的，我们在规则中加一行配置，来过滤除了账号密码错误外，空白账号或者密码的错误：\n[Definition]\nfailregex = ^ [error] d+#d+: d+ user “\\S+”:? (password mismatch|was not found in “.”), client: «/span\u003eHOST\u003e, server: S+, request: “\\S+ \\S+ HTTP/\\d+.\\d+”, host: “\\S+”s*$\n^ [error] d+#d+: d+ no user/password was provided for basic authentication, client: «/strong\u003eHOST\u003e, server: S+, request: “\\S+ \\S+ HTTP/\\d+.\\d+”, host: “\\S+”s$\nignoreregex =\n添加的是加粗的那一行。\ncp apache-badbots.conf nginx-badbots.conf 过滤爬虫的规则是有现成的，所以我们只需要改个名就可以了；\nvim nginx-nohome.conf 这是过滤获取目录的：\n[Definition]\nfailregex = ^«/span\u003eHOST\u003e -.GET ./~.*\nignoreregex =\nvim nginx-noproxy.conf 这是过滤反代的：\n[Definition]\nfailregex = ^«/span\u003eHOST\u003e –.GET http.\nignoreregex =\nvim wp-login.conf 这是防止 WordPress 受到 xmlrpc.php 请求的 CC 攻击：\n[Definition]\nfailregex = ^«/span\u003eHOST\u003e -.* /wp-login.php.* HTTP/1..“\nignoreregex =\nvim xmlrpc.conf 防范 WordPress 暴力破解登录请求\n[Definition]\nfailregex = ^«/span\u003eHOST\u003e -.*POST .*xmlrpc.php.*\nignoreregex =\n跋涉者提示 很多网站上面的代码都不正确，是因为，高亮代码不知道怎么会屏蔽这个语法，造成错误，本文已经更正，放心的使用。\n做完上述配置之后，就可以重启\nservice fail2ban restart 这时你可以通过命令 fail2ban-client status 来查看，不出意外，应该类似这样：\nfail2ban-client status 或者：/usr/local/python/bin/fail2ban-client status Status\n|- Number of jail: 7\n`- Jail list: nginx-badbots, nginx-http-auth, nginx-nohome, nginx-noproxy, sshd, wp-login, xmlrpc\n至此，Fail2Ban 保护 Nginx、WordPress 基本算是完成了，至少跋涉者目前需要的安全策略都完成了，平时可以观察一下 Fail2Ban 的日志文件来观察 Fail2Ban 的防御效果，如：\ntail -f /var/log/fail2ban.log iptables --list -n 用 Fail2Ban屏蔽无效的404请求 借助 Fail2Ban 可以筛选出发送这些请求的 IP 地址来进行拦截屏蔽处理，根据日志中返回 404 的记录制定 Fail2Ban 监狱规则命名为 nginx-not-found.conf，具体内容如下：\nvim /etc/fail2ban/filter.d/nginx-not-found.conf 打开编辑 nginx-not-found.conf 监狱规则文件，注意一定要在/etc/fail2ban/filter.d/目录内哦。\n[Definition] failregex = ^.*\"(GET|POST).*\" (404|444|403|400) .*$ ignoreregex = 保存退出。\n再打开编辑 jail.local 启用这个监狱规则。\nvim /etc/fail2ban/jail.local 添加下面的代码到 jail.local 里即可。同样的，注意 jail.local 文件的目录哦。\n[nginxno404] #处理 nginx 下的恶意 404 结果扫描 enabled = true port = http,https filter = nginx-not-found action = iptables[name=nginxno404, port=http, protocol=tcp] #Fail2Ban 要监控的站点日志文件，大家可以根据自己站点来灵活调整。 logpath = /home/wwwlogs/access.log bantime = 3600 #默认是屏蔽 IP 地址 10 分钟 #下面这两个是说 60 秒内 5 次 404 失败请求就开始屏蔽这个 IP 地址 findtime = 60 maxretry = 5 保存退出。\n重新启动 Fail2Ban：\nsystemctl restart fail2ban.service 看下日志：\nnginxno404已经开始生效，并且Ban了一个ip，14.204.69.48\n看一下iptables的记录，如上图，已经拒绝这个IP的访问了\n本文参考了落格部落及明月登楼博客里的一些文章，在此表示感谢\n","wordCount":"2857","inLanguage":"zh-cn","image":"https://iliu.org/img/liujinsuiyue.jpg","datePublished":"2019-07-28T09:07:40Z","dateModified":"2019-07-28T09:07:40Z","author":{"@type":"Person","name":"老刘"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://iliu.org/2556.html"},"publisher":{"@type":"Organization","name":"老刘博客","logo":{"@type":"ImageObject","url":"https://iliu.org/img/favicon"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://iliu.org/ accesskey=h title="老刘博客 (Alt + H)"><img src=https://iliu.org/img/apple-touch-icon.png alt aria-label=logo height=35>老刘博客</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://iliu.org/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://iliu.org/archives/ title=⏱归档><span>⏱归档</span></a></li><li><a href=https://iliu.org/boyoupeijing/ title=👓配镜><span>👓配镜</span></a></li><li><a href=https://iliu.org/search title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://iliu.org/>Home</a>&nbsp;»&nbsp;<a href=https://iliu.org/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">lnmp一键开启waf及使用 Fail2Ban防护</h1><div class=post-meta><span title='2019-07-28 09:07:40 +0000 +0000'>2019-07-28</span>&nbsp;·&nbsp;<span>6 min</span>&nbsp;·&nbsp;<span>2857 words</span>&nbsp;·&nbsp;<span>老刘</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#lnmp开启waf的方法>lnmp开启waf的方法</a><ul><li></li></ul></li><li><a href=#使用-fail2ban防护网站及服务器>使用 Fail2Ban防护网站及服务器</a></li><li><a href=#vim-nginx-nohomeconf>vim nginx-nohome.conf</a></li><li><a href=#vim-nginx-noproxyconf>vim nginx-noproxy.conf</a></li><li><a href=#vim-wp-loginconf><strong>vim wp-login.conf</strong></a></li><li><a href=#vim-xmlrpcconf><strong>vim xmlrpc.conf</strong></a></li><li><a href=#跋涉者提示><span>跋涉者提示</span></a></li><li><a href=#用fail2ban屏蔽无效的404请求>用 Fail2Ban屏蔽无效的404请求</a></li></ul></nav></div></details></div><div class=post-content><p>试用了阿里云香港的轻量服务器之后，赶紧确实是一个不错的选择，因此，决定把网站给迁移过来。以前都是用的oneinstack安装包，这是因为军哥的lnmp如果使用mysql5.6以上的话就必须要内存2G衣裳，这次用的就是2G的，所以还是使用lnmp一键安装包比较舒心。和one的区别是，one很多的事项在编译环境的时候已经弄好了，而lnmp需要西西的打磨，这也是一个好事，毕竟服务器不同，弄的规则也不尽一样。闲言少续，开始正体。</p><h2 id=lnmp开启waf的方法>lnmp开启waf的方法<a hidden class=anchor aria-hidden=true href=#lnmp开启waf的方法>#</a></h2><p><span style=background-color:#fff;color:#404040>LNMP一键安装包从1.5开始增加了lua支持的选项，可以通过修改lnmp.conf中Enable_Nginx_Lua后的参数为 y 来启用lua，如果没安装lnmp，修改lnmp.conf后保存，安装完lnmp就是支持lua的，如果已经安装好lnmp，也是按前面修改lnmp.conf，然后lnmp安装包目录下 </span><strong style=background-color:#fff;color:#000>./upgrade.sh nginx</strong><span style=background-color:#fff;color:#404040> 升级nginx，输入当前 </span><a style=background-color:#fff;color:#404040 href=http://www.codercto.com/category/nginx.html target=_blank rel="noopener noreferrer">nginx</a><span style=background-color:#fff;color:#404040> 版本号或更新的nginx版本号，升级完成就是支持lua的了。</span></p><h4 id=下载安装ngx_lua_waf><strong>下载安装ngx_lua_waf：</strong><a hidden class=anchor aria-hidden=true href=#下载安装ngx_lua_waf>#</a></h4><p>wget <a href=https://github.com/loveshell/ngx>https://github.com/loveshell/ngx</a>_lua_waf/archive/master.zip -O ngx_lua_waf.zip</p><p>unzip ngx_lua_waf.zip</p><p>mv ngx_lua_waf-master /usr/local/nginx/conf/waf</p><h4 id=nginx上设置并启用ngx_lua_waf><strong>nginx上设置并启用ngx_lua_waf</strong><a hidden class=anchor aria-hidden=true href=#nginx上设置并启用ngx_lua_waf>#</a></h4><p>编辑 /usr/local/nginx/conf/nginx.conf 在 server_tokens off; 下面添加如下代码：</p><p>lua_package_path “/usr/local/nginx/conf/waf/?.lua”;</p><p>lua_shared_dict limit 10m;</p><p>init_by_lua_file /usr/local/nginx/conf/waf/init.lua;</p><p>修改完成保存</p><p>如果要想在某个虚拟主机启用ngx_lua_waf可以修改对应虚拟主机的server段，在该server段中 root 网站目录行下面添加如下代码：</p><p>access_by_lua_file /usr/local/nginx/conf/waf/waf.lua;</p><p>修改完成保存</p><p>测试nginx配置文件： <strong style=color:#000>/usr/local/nginx/sbin/nginx -t</strong></p><p>重载nginx配置生效： <strong style=color:#000>/usr/local/nginx/sbin/nginx -s reload</strong></p><p>如果测试和重载都没报错就已经生效。</p><p>可以通过访问 http://域名/test.php?id=../etc/passwd 来测试<figure id=2559 class=content-img-box></p><p><img decoding=async id=412D35F8 class=po-img-big src=https://tunan.org/wp-content/uploads/2019/07/1d3c90a5a17d65.JPG alt="lnmp一键开启waf及使用 Fail2Ban防护"><figcaption class=addDesn></figcaption></figure></p><p>提示：您的请求带有>不合法参数，已被网站管理员设置拦截！说明已经正确设置</p><p>ngx_lua_waf配置文件位置：/usr/local/nginx/conf/waf/config.lua</p><h2 id=使用-fail2ban防护网站及服务器>使用 Fail2Ban防护网站及服务器<a hidden class=anchor aria-hidden=true href=#使用-fail2ban防护网站及服务器>#</a></h2><p><span style=background-color:#fff;color:#333>Fail2Ban 是一种入侵防御软件框架，可以保护计算机服务器免受暴力攻击。它以 Python 编程语言编写，能够在 POSIX 系统上运行，该系统具有本地安装的数据包控制系统或防火墙的接口，例如 iptables 或 TCP Wrapper。</span></p><p><span style=background-color:#fff;color:#333>所以要想使用Fail2Ban，就必须让服务器识别来源的真实IP地址，而不是套的cdn的地址。</span></p><p><strong style=background-color:#fff;color:#333>套用CDN后获取来源的真实IP的方法</strong></p><p>在nginx.conf内的http下增加：</p><p>#自定义一个日志格式</p><p><code>log_format main '$http_x_forwarded_for - $remote_user [$time_local] '</code></p><p>‘”<span style=color:blue>$request</span>” <span style=color:blue>$status</span> $body_bytes_sent ‘</p><p>‘”$http_referer” “$http_user_agent”‘;</p><p>然后<span style=background-color:#fff;color:#333>修改access_log /home/wwwlogs/xxxx.log; 为access_log /home/wwwlogs/xxxx.log main;</span></p><p><span style=background-color:#fff;color:#333>nginx-t 检查无误后，service nginx restart,现在在看日志文件，里面的地址就是真正的来源地址了。</span></p><p><strong>使用 Fail2Ban 保护 Nginx、WordPress</strong></p><pre class=ql-syntax spellcheck=false><span class=hljs-attribute>cp</span> /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
</pre><p>Fail2Ban 会自动读取 .local 文件的配置，然后再<strong>增量</strong>地读取 conf 配置，这样就避免了更新它时你辛辛苦苦写好的配置被覆盖掉了。</p><p>然后我们就来编辑 Fail2Ban 的配置</p><pre class=ql-syntax spellcheck=false><span class=hljs-attribute>vim</span> /etc/fail2ban/jail.local
</pre><p>首先是在 [DEFAULT] 字段下，我们可以改变一些行为参数，比如这样修改（多余的没有提到的配置就保留默认，不要理会即可）：</p><pre class=ql-syntax spellcheck=false>bantime = 3600 <span class=hljs-comment>#默认是 10 分钟，这个是说要 ban 多久，我们改长一点</span>
<span class=hljs-comment>#下面这两个是说在多长时间内失败多少次就被屏蔽，</span>
<span class=hljs-comment>#比如这个是在 3600 秒内失败 6 次就被屏蔽</span>
findtime = 3600
maxretry = 6  
</pre><p>接下来就是添加我们的监狱配置了，默认配置信息中并没有内置 Nginx ，只有 Apache：</p><pre class=ql-syntax spellcheck=false><span class=hljs-section>[nginx-http-auth]</span>
<span class=hljs-comment># HTTP 验证防暴力破解</span>
<span class=hljs-attr>enabled</span>  = <span class=hljs-literal>true</span>
<span class=hljs-attr>filter</span>  = nginx-http-auth
<span class=hljs-attr>port</span>    = http,https
<span class=hljs-attr>logpath</span>  = /var/log/nginx/error.log
<span class=hljs-section> 
[nginx-badbots]</span>
<span class=hljs-comment>#屏蔽恶意爬虫</span>
<span class=hljs-attr>enabled</span>  = <span class=hljs-literal>true</span>
<span class=hljs-attr>port</span>    = http,https
<span class=hljs-attr>filter</span>  = nginx-badbots
<span class=hljs-attr>logpath</span>  = /var/log/nginx/access.log
<span class=hljs-attr>maxretry</span> = <span class=hljs-number>2</span>
<span class=hljs-section> 
[nginx-nohome]</span>
<span class=hljs-comment>#避免恶意请求网站目录结构</span>
<span class=hljs-attr>enabled</span>  = <span class=hljs-literal>true</span>
<span class=hljs-attr>port</span>    = http,https
<span class=hljs-attr>filter</span>  = nginx-nohome
<span class=hljs-attr>logpath</span>  = /var/log/nginx/access.log
<span class=hljs-attr>maxretry</span> = <span class=hljs-number>2</span>
<span class=hljs-section> 
[nginx-noproxy]</span>
<span class=hljs-comment>#避免 nginx 被他人用于反向代理</span>
<span class=hljs-attr>enabled</span>  = <span class=hljs-literal>true</span>
<span class=hljs-attr>port</span>    = http,https
<span class=hljs-attr>filter</span>  = nginx-noproxy
<span class=hljs-attr>logpath</span>  = /var/log/nginx/access.log
<span class=hljs-attr>maxretry</span> = <span class=hljs-number>2</span>
<span class=hljs-section>
[wp-login]</span>
<span class=hljs-comment>#防范 WordPress 暴力破解登录请求</span>
<span class=hljs-attr>enabled</span> = <span class=hljs-literal>true</span>
<span class=hljs-attr>port</span> = http,https
<span class=hljs-attr>filter</span> = wp-login
<span class=hljs-attr>maxretry</span> = <span class=hljs-number>10</span>
<span class=hljs-attr>findtime</span> = <span class=hljs-number>60</span>
<span class=hljs-attr>bantime</span> = <span class=hljs-number>43600</span>
<span class=hljs-attr>logpath</span>  = /var/log/nginx/access.log
<span class=hljs-section>
[xmlrpc]</span>
<span class=hljs-comment>#防止 WordPress 受到 xmlrpc.php CC 攻击</span>
<span class=hljs-attr>enabled</span> = <span class=hljs-literal>true</span>
<span class=hljs-attr>port</span> = http,https
<span class=hljs-attr>filter</span> = xmlrpc
<span class=hljs-attr>logpath</span>  = /var/log/nginx/access.log
<span class=hljs-attr>bantime</span> = <span class=hljs-number>43600</span>
<span class=hljs-attr>maxretry</span> = <span class=hljs-number>1</span>
<span class=hljs-attr>findtime</span>  = <span class=hljs-number>5</span>
</pre><p>注意这里的配置都是基于 Nginx 的日志的，所以你必须要允许 Nginx 记录日志，有些管理员为了性能考量会关闭日志，这样我们这篇文章也就失去了意义。</p><p>上述配置中 logpath 是指日志文件的路径的（如：/var/log/nginx/access.log），需要注意的是这里可以指定多个日志文件的，具体格式如下：</p><pre class=ql-syntax spellcheck=false>logpath  = /home/wwwlogs/access.<span class=hljs-built_in>log</span>
           /home/wwwlogs/www<span class=hljs-number>.1111</span>.com.<span class=hljs-built_in>log</span>
           /home/wwwlogs/www<span class=hljs-number>.2222</span>.tech.<span class=hljs-built_in>log</span>
           /home/wwwlogs/service<span class=hljs-number>.3333</span>.com.<span class=hljs-built_in>log</span>
           /home/wwwlogs/eat<span class=hljs-number>.4444</span>.com.<span class=hljs-built_in>log</span>
</pre><p><strong>每个日志文件需要回车换行（空格直接去掉了，所以可以放心用空格对齐）才能识别到哦！</strong></p><blockquote><p>另，在配置 Fail2Ban 之前，你就应该先安装好 Nginx，否则 Fail2Ban 读不到 Nginx 的日志，会报错。</p></blockquote><p>设置好了要启用的监狱，接下来就是给监狱创建规则了：</p><pre class=ql-syntax spellcheck=false><span class=hljs-built_in>cd</span> /etc/fail2ban/filter.d
</pre><p>在这个目录下，存放这所有规则文件，一个配置名一个文件，有多少个文件就有多少个规则，这些规则被上文中监狱配置里 filter 字段调用。</p><pre class=ql-syntax spellcheck=false>vim nginx-http-auth.conf
</pre><p>这个规则是存在的，我们在规则中加一行配置，来过滤除了账号密码错误外，空白账号或者密码的错误：</p><p><span style=color:#333>[</span><span style=color:#5c2699>Definition</span><span style=color:#333>]</span></p><p><span style=color:#5c2699>failregex</span> <span style=color:#2e0d6e>=</span> <span style=color:#2e0d6e>^</span> <span style=color:#333>[</span><span style=color:#5c2699>error</span><span style=color:#333>]</span> <span style=color:#333>&lt;/span><span style=color:#5c2699>d</span><span style=color:#2e0d6e>+#</span><span style=color:#333>&lt;/span><span style=color:#5c2699>d</span><span style=color:#2e0d6e>+:</span> <span style=color:#333>&lt;/span><span style=color:#2e0d6e><em></span><span style=color:#333>&lt;/span><span style=color:#5c2699>d</span><span style=color:#2e0d6e>+</span> <span style=color:#aa0d91>user</span> <span style=color:#c41a16>“\S+”</span><span style=color:#2e0d6e>:</span><span style=color:#333>?</span> <span style=color:#333>(</span><span style=color:#2e0d6e>password </span><span style=color:#5c2699>mismatch</span><span style=color:#2e0d6e>|was </span><span style=color:#aa0d91>not</span> <span style=color:#2e0d6e>found </span><span style=color:#aa0d91>in</span> <span style=color:#c41a16>“.</em>”</span><span style=color:#333>),</span> <span style=color:#5c2699>client</span><span style=color:#2e0d6e>:</span> <span style=color:#2e0d6e>&#171;/span><span style=color:#5c2699>HOST</span><span style=color:#2e0d6e>></span><span style=color:#333>,</span> <span style=color:#5c2699>server</span><span style=color:#2e0d6e>:</span> <span style=color:#333>&lt;/span><span style=color:#5c2699>S</span><span style=color:#2e0d6e>+</span><span style=color:#333>,</span> <span style=color:#5c2699>request</span><span style=color:#2e0d6e>:</span> <span style=color:#c41a16>“\S+ \S+ HTTP/\d+.\d+”</span><span style=color:#333>,</span> <span style=color:#5c2699>host</span><span style=color:#2e0d6e>:</span> <span style=color:#c41a16>“\S+”</span><span style=color:#333>&lt;/span><span style=color:#5c2699>s</span><span style=color:#2e0d6e>*</span><span style=color:#333>$</span></p><p><strong style=color:#2e0d6e;background-color:#cce0f5>^</strong> <strong style=color:#333;background-color:#cce0f5>[</strong><strong style=color:#5c2699;background-color:#cce0f5>error</strong><strong style=color:#333;background-color:#cce0f5>]</strong> <strong style=color:#333;background-color:#cce0f5>&lt;/strong><strong style=color:#5c2699;background-color:#cce0f5>d</strong><strong style=color:#2e0d6e;background-color:#cce0f5>+#</strong><strong style=color:#333;background-color:#cce0f5>&lt;/strong><strong style=color:#5c2699;background-color:#cce0f5>d</strong><strong style=color:#2e0d6e;background-color:#cce0f5>+:</strong> <strong style=color:#333;background-color:#cce0f5>&lt;/strong><strong style=color:#2e0d6e;background-color:#cce0f5><em></strong><strong style=color:#333;background-color:#cce0f5>&lt;/strong><strong style=color:#5c2699;background-color:#cce0f5>d</strong><strong style=color:#2e0d6e;background-color:#cce0f5>+</strong> <strong style=color:#2e0d6e;background-color:#cce0f5>no </strong><strong style=color:#5c2699;background-color:#cce0f5>user</strong><strong style=color:#2e0d6e;background-color:#cce0f5>/password was provided </strong><strong style=color:#aa0d91;background-color:#cce0f5>for</strong> <strong style=color:#2e0d6e;background-color:#cce0f5>basic </strong><strong style=color:#5c2699;background-color:#cce0f5>authentication</strong><strong style=color:#333;background-color:#cce0f5>,</strong> <strong style=color:#5c2699;background-color:#cce0f5>client</strong><strong style=color:#2e0d6e;background-color:#cce0f5>:</strong> <strong style=color:#2e0d6e;background-color:#cce0f5>&#171;/strong><strong style=color:#5c2699;background-color:#cce0f5>HOST</strong><strong style=color:#2e0d6e;background-color:#cce0f5>></strong><strong style=color:#333;background-color:#cce0f5>,</strong> <strong style=color:#5c2699;background-color:#cce0f5>server</strong><strong style=color:#2e0d6e;background-color:#cce0f5>:</strong> <strong style=color:#333;background-color:#cce0f5>&lt;/strong><strong style=color:#5c2699;background-color:#cce0f5>S</strong><strong style=color:#2e0d6e;background-color:#cce0f5>+</strong><strong style=color:#333;background-color:#cce0f5>,</strong> <strong style=color:#5c2699;background-color:#cce0f5>request</strong><strong style=color:#2e0d6e;background-color:#cce0f5>:</strong> <strong style=color:#c41a16;background-color:#cce0f5>“\S+ \S+ HTTP/\d+.\d+”</strong><strong style=color:#333;background-color:#cce0f5>,</strong> <strong style=color:#5c2699;background-color:#cce0f5>host</strong><strong style=color:#2e0d6e;background-color:#cce0f5>:</strong> <strong style=color:#c41a16;background-color:#cce0f5>“\S+”</strong><strong style=color:#333;background-color:#cce0f5>&lt;/strong><strong style=color:#5c2699;background-color:#cce0f5>s</strong><strong style=color:#2e0d6e;background-color:#cce0f5></em></strong><strong style=color:#333;background-color:#cce0f5>$</strong></p><p><span style=color:#5c2699>ignoreregex</span> <span style=color:#2e0d6e>=</span></p><p>添加的是加粗的那一行。</p><pre class=ql-syntax spellcheck=false>cp apache-badbots.conf nginx-badbots.conf
</pre><p>过滤爬虫的规则是有现成的，所以我们只需要改个名就可以了；</p><h2 id=vim-nginx-nohomeconf>vim nginx-nohome.conf<a hidden class=anchor aria-hidden=true href=#vim-nginx-nohomeconf>#</a></h2><p>这是过滤获取目录的：</p><p><em style=color:#007400>[Definition]</em></p><p><em style=color:#007400>failregex = ^</em><span style=color:#2e0d6e;background-color:#fff>&#171;/span><span style=color:#5c2699;background-color:#fff>HOST</span><span style=color:#2e0d6e;background-color:#fff>></span> <em style=color:#007400>-.<em>GET .</em>/</em><span style=color:#2e0d6e>~</span><span style=color:#333>.</span><span style=color:#2e0d6e>*</span></p><p><span style=color:#5c2699>ignoreregex</span> <span style=color:#2e0d6e>=</span></p><h2 id=vim-nginx-noproxyconf>vim nginx-noproxy.conf<a hidden class=anchor aria-hidden=true href=#vim-nginx-noproxyconf>#</a></h2><p>这是过滤反代的：</p><p><span style=color:#333>[</span><span style=color:#5c2699>Definition</span><span style=color:#333>]</span></p><p><span style=color:#5c2699>failregex</span> <span style=color:#2e0d6e>=</span> <span style=color:#2e0d6e>^&#171;/span><span style=color:#5c2699>HOST</span><span style=color:#2e0d6e>></span> <span style=color:#2e0d6e>–</span><span style=color:#333>.</span><span style=color:#2e0d6e><em></span><span style=color:purple>GET</span> <span style=color:#5c2699>http</span><span style=color:#333>.</span><span style=color:#2e0d6e></em></span></p><p><span style=color:#5c2699>ignoreregex</span> <span style=color:#2e0d6e>=</span></p><h2 id=vim-wp-loginconf><strong>vim wp-login.conf</strong><a hidden class=anchor aria-hidden=true href=#vim-wp-loginconf>#</a></h2><p>这是防止 WordPress 受到 xmlrpc.php 请求的 CC 攻击：</p><p><span style=background-color:#f8f8f8;color:#333>[Definition]</span></p><p><span style=background-color:#f8f8f8;color:#333>failregex = ^</span><span style=background-color:#fff;color:#2e0d6e>&#171;/span><span style=background-color:#fff;color:#5c2699>HOST</span><span style=background-color:#fff;color:#2e0d6e>></span> <span style=background-color:#f8f8f8;color:#333>-.* /wp-login.php.* HTTP/1..</span><span class=hljs-string style=color:#d14>“</span></p><p><span class=hljs-string style=color:#d14>ignoreregex =</span></p><h2 id=vim-xmlrpcconf><strong>vim xmlrpc.conf</strong><a hidden class=anchor aria-hidden=true href=#vim-xmlrpcconf>#</a></h2><p>防范 WordPress 暴力破解登录请求</p><p>[Definition]</p><p>failregex = ^<span style=background-color:#fff;color:#2e0d6e>&#171;/span><span style=background-color:#fff;color:#5c2699>HOST</span><span style=background-color:#fff;color:#2e0d6e>></span> -.*POST .*xmlrpc.php.*</p><p>ignoreregex =</p><h2 id=跋涉者提示><span style=color:#f90>跋涉者提示</span><a hidden class=anchor aria-hidden=true href=#跋涉者提示>#</a></h2><p><span style=color:#f90>很多网站上面的代码都不正确，是因为，高亮代码不知道怎么会屏蔽</span><span style=color:#f90;background-color:#fff>这个语法，造成错误，本文已经更正，放心的使用。</span></p><p>做完上述配置之后，就可以重启</p><pre class=ql-syntax spellcheck=false> <span class=hljs-attribute>service</span> fail2ban restart
</pre><p>这时你可以通过命令 fail2ban-client status 来查看，不出意外，应该类似这样：</p><pre class=ql-syntax spellcheck=false>fail2ban-client status
或者：/usr/local/python/bin/fail2ban-client status</pre><p>Status</p><p>|- Number of jail: 7</p><p>`- Jail list: nginx-badbots, nginx-http-auth, nginx-nohome, nginx-noproxy, sshd, wp-login, xmlrpc</p><p>至此，Fail2Ban 保护 Nginx、WordPress 基本算是完成了，至少跋涉者目前需要的安全策略都完成了，平时可以观察一下 Fail2Ban 的日志文件来观察 Fail2Ban 的防御效果，如：</p><pre class=ql-syntax spellcheck=false>tail -f /var/<span class=hljs-built_in>log</span>/fail2ban.<span class=hljs-built_in>log</span>
iptables --<span class=hljs-built_in>list</span> -n
</pre><h2 id=用fail2ban屏蔽无效的404请求>用 Fail2Ban屏蔽无效的404请求<a hidden class=anchor aria-hidden=true href=#用fail2ban屏蔽无效的404请求>#</a></h2><p>借助 Fail2Ban 可以筛选出发送这些请求的 IP 地址来进行拦截屏蔽处理，根据日志中返回 404 的记录制定 Fail2Ban 监狱规则命名为 nginx-not-found.conf，具体内容如下：</p><pre class=ql-syntax spellcheck=false>vim /etc/fail2ban/filter.d/nginx-<span class=hljs-keyword>not</span>-found.conf
</pre><p>打开编辑 nginx-not-found.conf 监狱规则文件，注意一定要在<span style=color:#333;background-color:#fff>/etc/fail2ban/filter.d/目录内哦</span>。</p><pre class=ql-syntax spellcheck=false>[Definition]
failregex = ^&lt;HOST&gt;.*"(GET|POST).*" (404|444|403|400) .*$
ignoreregex =
</pre><p>保存退出。</p><p>再打开编辑 jail.local 启用这个监狱规则。</p><pre class=ql-syntax spellcheck=false><span class=hljs-attribute>vim</span> /etc/fail2ban/jail.local
</pre><p>添加下面的代码到 jail.local 里即可。同样的，注意 jail.local 文件的目录哦。</p><pre class=ql-syntax spellcheck=false><span class=hljs-section>[nginxno404]</span>
<span class=hljs-comment>#处理 nginx 下的恶意 404 结果扫描</span>
<span class=hljs-attr>enabled</span> = <span class=hljs-literal>true</span>
<span class=hljs-attr>port</span> = http,https
<span class=hljs-attr>filter</span> = nginx-not-found
<span class=hljs-attr>action</span> = iptables[name=nginxno404, port=http, protocol=tcp]
<span class=hljs-comment>#Fail2Ban 要监控的站点日志文件，大家可以根据自己站点来灵活调整。</span>
<span class=hljs-attr>logpath</span>  = /home/wwwlogs/access.log
           
<span class=hljs-attr>bantime</span> = <span class=hljs-number>3600</span> #默认是屏蔽 IP 地址 <span class=hljs-number>10</span> 分钟
<span class=hljs-comment>#下面这两个是说 60 秒内 5 次 404 失败请求就开始屏蔽这个 IP 地址</span>
<span class=hljs-attr>findtime</span> = <span class=hljs-number>60</span>
<span class=hljs-attr>maxretry</span> = <span class=hljs-number>5</span>
</pre><p>保存退出。</p><p>重新启动 Fail2Ban：</p><pre class=ql-syntax spellcheck=false>systemctl restart fail2ban.service
</pre><p>看下日志：<figure id=2561 class=content-img-box></p><p><img decoding=async id=23B1CECF class=po-img-big src=https://tunan.org/wp-content/uploads/2019/07/136d1bd3715987.JPG alt="lnmp一键开启waf及使用 Fail2Ban防护"><figcaption class=addDesn></figcaption></figure></p><p>nginxno404已经开始生效，并且Ban了一个ip，14.204.69.48<figure id=2560 class=content-img-box></p><p><img decoding=async id=8BDD51AF class=po-img-big src=https://tunan.org/wp-content/uploads/2019/07/16ce4571631d8d.JPG alt="lnmp一键开启waf及使用 Fail2Ban防护"><figcaption class=addDesn></figcaption></figure></p><p>看一下iptables的记录，如上图，已经拒绝这个IP的访问了</p><p>本文参考了<a href=https://www.logcg.com/archives/2998.html target=_blank rel="noopener noreferrer">落格部落</a>及<a href=https://www.imydl.com target=_blank rel="noopener noreferrer">明月登楼博客</a>里的一些文章，在此表示感谢</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://iliu.org/tags/cnd%E8%8E%B7%E5%8F%96%E7%9C%9F%E5%AE%9Eip/>Cnd获取真实ip</a></li><li><a href=https://iliu.org/tags/fail2ban/>Fail2Ban</a></li><li><a href=https://iliu.org/tags/lnmp/>Lnmp</a></li></ul><nav class=paginav><a class=prev href=https://iliu.org/2574.html><span class=title>«</span><br><span>尽信书不如无书</span>
</a><a class=next href=https://iliu.org/2552.html><span class=title>»</span><br><span>给7b2的主题加上评论回复功能</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share lnmp一键开启waf及使用 Fail2Ban防护 on x" href="https://x.com/intent/tweet/?text=lnmp%e4%b8%80%e9%94%ae%e5%bc%80%e5%90%afwaf%e5%8f%8a%e4%bd%bf%e7%94%a8%20Fail2Ban%e9%98%b2%e6%8a%a4&amp;url=https%3a%2f%2filiu.org%2f2556.html&amp;hashtags=cnd%e8%8e%b7%e5%8f%96%e7%9c%9f%e5%ae%9eip%2cFail2Ban%2clnmp"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share lnmp一键开启waf及使用 Fail2Ban防护 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2filiu.org%2f2556.html&amp;title=lnmp%e4%b8%80%e9%94%ae%e5%bc%80%e5%90%afwaf%e5%8f%8a%e4%bd%bf%e7%94%a8%20Fail2Ban%e9%98%b2%e6%8a%a4&amp;summary=lnmp%e4%b8%80%e9%94%ae%e5%bc%80%e5%90%afwaf%e5%8f%8a%e4%bd%bf%e7%94%a8%20Fail2Ban%e9%98%b2%e6%8a%a4&amp;source=https%3a%2f%2filiu.org%2f2556.html"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share lnmp一键开启waf及使用 Fail2Ban防护 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2filiu.org%2f2556.html&title=lnmp%e4%b8%80%e9%94%ae%e5%bc%80%e5%90%afwaf%e5%8f%8a%e4%bd%bf%e7%94%a8%20Fail2Ban%e9%98%b2%e6%8a%a4"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share lnmp一键开启waf及使用 Fail2Ban防护 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2filiu.org%2f2556.html"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share lnmp一键开启waf及使用 Fail2Ban防护 on whatsapp" href="https://api.whatsapp.com/send?text=lnmp%e4%b8%80%e9%94%ae%e5%bc%80%e5%90%afwaf%e5%8f%8a%e4%bd%bf%e7%94%a8%20Fail2Ban%e9%98%b2%e6%8a%a4%20-%20https%3a%2f%2filiu.org%2f2556.html"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share lnmp一键开启waf及使用 Fail2Ban防护 on telegram" href="https://telegram.me/share/url?text=lnmp%e4%b8%80%e9%94%ae%e5%bc%80%e5%90%afwaf%e5%8f%8a%e4%bd%bf%e7%94%a8%20Fail2Ban%e9%98%b2%e6%8a%a4&amp;url=https%3a%2f%2filiu.org%2f2556.html"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share lnmp一键开启waf及使用 Fail2Ban防护 on ycombinator" href="https://news.ycombinator.com/submitlink?t=lnmp%e4%b8%80%e9%94%ae%e5%bc%80%e5%90%afwaf%e5%8f%8a%e4%bd%bf%e7%94%a8%20Fail2Ban%e9%98%b2%e6%8a%a4&u=https%3a%2f%2filiu.org%2f2556.html"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://giscus.app/client.js data-repo=ewader/iliu.github.io data-repo-id=R_kgDOMpQzaw data-category=Announcements data-category-id=DIC_kwDOMpQza84Ch_02 data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2025 <a href=https://iliu.org/>老刘博客</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span><script defer src=https://jishu.l22.org/script.js data-website-id=8f4ca183-928f-47ff-ba5b-49fd36cd7a19></script></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>